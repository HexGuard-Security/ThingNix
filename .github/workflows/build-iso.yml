name: Build ThingNix ISO

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      build_x86_64:
        description: 'Build x86_64 ISO'
        type: boolean
        default: true
      build_aarch64:
        description: 'Build aarch64 ISO'
        type: boolean
        default: true

jobs:
  build:
    name: Build ThingNix ISO
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Nix
        uses: cachix/install-nix-action@v22
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            
      - name: Install dependencies
        run: nix-shell -p nixos-generators git --run "echo 'Dependencies installed'"
        
      - name: Build ISOs
        run: |
          mkdir -p build
          chmod +x build.sh
          
          # Set environment variables for unfree packages
          export NIXPKGS_ALLOW_UNFREE=1
          
          if [[ "${{ github.event_name }}" != "workflow_dispatch" || "${{ inputs.build_x86_64 }}" == "true" ]]; then
            echo "Building x86_64 ISO..."
            ./build.sh --arch x86_64-linux
            echo "Creating x86_64 checksum..."
            cd build
            echo "Files in build directory:"
            ls -la
            
            # Find the actual ISO file and create checksum
            ISO_FILE=$(find . -name "*.iso" | head -n 1)
            if [ -n "$ISO_FILE" ]; then
              echo "Found ISO file: $ISO_FILE"
              sha256sum "$ISO_FILE" > thingnix-x86_64.sha256
              # Rename the ISO to a consistent name
              cp "$ISO_FILE" thingnix-x86_64.iso
            else
              echo "Warning: No x86_64 ISO found for checksum"
              touch thingnix-x86_64.sha256
            fi
            cd ..
          fi
          
          if [[ "${{ github.event_name }}" != "workflow_dispatch" || "${{ inputs.build_aarch64 }}" == "true" ]]; then
            echo "Building aarch64 ISO..."
            ./build.sh --arch aarch64-linux
            echo "Creating aarch64 checksum..."
            cd build
            echo "Files in build directory:"
            ls -la
            
            # Find the actual ISO file and create checksum
            ISO_FILE=$(find . -name "*.iso" | grep aarch64 | head -n 1)
            if [ -n "$ISO_FILE" ]; then
              echo "Found ISO file: $ISO_FILE"
              sha256sum "$ISO_FILE" > thingnix-aarch64.sha256
              # Rename the ISO to a consistent name
              cp "$ISO_FILE" thingnix-aarch64.iso
            else
              echo "Warning: No aarch64 ISO found for checksum"
              touch thingnix-aarch64.sha256
            fi
            cd ..
          fi
      
      - name: Upload build artifacts
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          name: ThingNix ${{ github.ref_name }}
          draft: true
          prerelease: true
          files: |
            build/thingnix-x86_64.iso
            build/thingnix-aarch64.iso
            build/thingnix-x86_64.sha256
            build/thingnix-aarch64.sha256
          body: |
            # ThingNix ${{ github.ref_name }}
            
            A reproducible NixOS-based operating system for IoT penetration testing and hardware hacking.
            
            ## Changes in this release
            <!-- Add release notes here -->
            
            ## Download
            
            - [x86_64 ISO](https://github.com/HexGuard-Security/ThingNix/releases/download/${{ github.ref_name }}/thingnix-x86_64.iso)
            - [aarch64 ISO](https://github.com/HexGuard-Security/ThingNix/releases/download/${{ github.ref_name }}/thingnix-aarch64.iso)
            
            ## Verification
            
            To verify the integrity of the downloaded ISO, use the provided checksums:
            ```
            sha256sum -c thingnix-x86_64.sha256
            sha256sum -c thingnix-aarch64.sha256
            ```
